const translations = {
    en: {
        'Edible': 'Edible',
        'Culinary Adventures for Young Chefs': 'Culinary Adventures for Young Chefs',
        'nav_recipes': 'Recipes',
        'nav_equipment': 'Equipment',
        'nav_questions': 'Questions',
        'nav_documentation': 'Documentation',
        'nav_cooks': 'Cooks',
        'q1_text': 'Have you ever cooked before?',
        'q2_text': 'Do you enjoy trying new foods?',
        'q3_text': 'How adventurous are you with food?',
        'q4_text': 'How much do you like cooking?',
        'q5_text': 'How confident are you in the kitchen?',
        'yes_option': 'Yes',
        'no_option': 'No',
        'done_button': 'Done',
        'slider_value_prefix': 'Value: ',
        'recipes_title': 'Our Recipes',
        'skill_level_prompt': 'Select Your Skill Level',
        'skill_level_beginner': 'Beginner',
        'skill_level_intermediate': 'Intermediate',
        'skill_level_advanced': 'Advanced',
        'show_favorite_recipes': 'Show Favorite Recipes',
        'view_recipe_btn': 'View Recipe',
        'skill_level_label': 'Skill Level',
        'ingredients_label': 'Ingredients',
        'instructions_label': 'Instructions',
        'back_to_recipes_btn': 'Back to Recipes',
        'equipment_title': "Kids' Kitchen Equipment",
        'cooks_title': 'Cooks',
        'chef1_name': 'John Doe',
        'chef1_title': 'Head Chef',
        'chef1_bio': 'John has been cooking for over 10 years and has a passion for creating new recipes.',
        'chef2_name': 'Jane Doe',
        'chef2_title': 'Sous Chef',
        'chef2_bio': 'Jane is a skilled chef with a focus on creating delicious and healthy meals.',
        'questions_forum_title': 'Questions Forum',
        'form_name_label': 'Your Name:',
        'form_email_label': 'Your Email:',
        'form_question_label': 'Your Question:',
        'form_send_button': 'Send Email',
        'doc_title': 'Edible App Documentation',
        'result_skill_level_prefix': 'Your Cooking Skill Level: ',
        'result_recommendation_intro': 'Based on your survey results, here are some recommended recipes:',
        'result_show_more_btn': 'Show More Recipes',
        'result_take_quiz_btn': 'Take Food Quiz',
        'accessibility_title': 'Accessibility Options',
        'accessibility_tts_label': 'Text-to-Speech',
        'accessibility_tts_off': 'Off',
        'accessibility_tts_on': 'On',
        'accessibility_language_label': 'Language',
        'accessibility_font_label': 'Font Type',
        'accessibility_font_regular': 'Regular',
        'accessibility_font_dyslexic': 'Comic Sans',
        'accessibility_contrast_label': 'High Contrast',
        'accessibility_contrast_normal': 'Normal',
        'accessibility_contrast_high': 'High Contrast',
        'accessibility_text_size_label': 'Text Size',
        'Fruit Smoothie': 'Fruit Smoothie', 'Refreshing fruit smoothie': 'Refreshing fruit smoothie',
        'Banana': 'Banana', 'Berries': 'Berries', 'Yogurt': 'Yogurt', 'Milk': 'Milk', 'Honey': 'Honey',
        'Add fruits': 'Add fruits', 'Add yogurt and milk': 'Add yogurt and milk', 'Blend until smooth': 'Blend until smooth', 'Add honey to taste': 'Add honey to taste',
        'Grilled Cheese': 'Grilled Cheese', 'Classic grilled cheese sandwich': 'Classic grilled cheese sandwich',
        'Bread': 'Bread', 'Cheese': 'Cheese', 'Butter': 'Butter',
        'Butter bread': 'Butter bread', 'Add cheese': 'Add cheese', 'Grill until golden': 'Grill until golden',
    },
    es: {
        'Edible': 'Comestible',
        'Culinary Adventures for Young Chefs': 'Aventuras Culinarias para Jóvenes Chefs',
        'nav_recipes': 'Recetas',
        'nav_equipment': 'Equipamiento',
        'nav_questions': 'Preguntas',
        'nav_documentation': 'Documentación',
        'nav_cooks': 'Cocineros',
        'q1_text': '¿Has cocinado antes?',
        'q2_text': '¿Disfrutas probando comidas nuevas?',
        'q3_text': '¿Qué tan aventurero eres con la comida?',
        'q4_text': '¿Cuánto te gusta cocinar?',
        'q5_text': '¿Qué tan seguro te sientes en la cocina?',
        'yes_option': 'Sí',
        'no_option': 'No',
        'done_button': 'Hecho',
        'slider_value_prefix': 'Valor: ',
        'recipes_title': 'Nuestras Recetas',
        'skill_level_prompt': 'Selecciona Tu Nivel de Habilidad',
        'skill_level_beginner': 'Principiante',
        'skill_level_intermediate': 'Intermedio',
        'skill_level_advanced': 'Avanzado',
        'show_favorite_recipes': 'Mostrar Recetas Favoritas',
        'view_recipe_btn': 'Ver Receta',
        'skill_level_label': 'Nivel de Habilidad',
        'ingredients_label': 'Ingredientes',
        'instructions_label': 'Instrucciones',
        'back_to_recipes_btn': 'Volver a Recetas',
        'equipment_title': "Equipamiento de Cocina para Niños",
        'cooks_title': 'Cocineros',
        'chef1_name': 'Juan Pérez',
        'chef1_title': 'Chef Principal',
        'chef1_bio': 'Juan ha estado cocinando por más de 10 años y le apasiona crear nuevas recetas.',
        'chef2_name': 'Juana Pérez',
        'chef2_title': 'Subchef',
        'chef2_bio': 'Juana es una chef experta enfocada en crear comidas deliciosas y saludables.',
        'questions_forum_title': 'Foro de Preguntas',
        'form_name_label': 'Tu Nombre:',
        'form_email_label': 'Tu Correo Electrónico:',
        'form_question_label': 'Tu Pregunta:',
        'form_send_button': 'Enviar Correo',
        'doc_title': 'Documentación de la App Edible',
        'result_skill_level_prefix': 'Tu Nivel de Habilidad Culinaria: ',
        'result_recommendation_intro': 'Según los resultados de tu encuesta, aquí tienes algunas recetas recomendadas:',
        'result_show_more_btn': 'Mostrar Más Recetas',
        'result_take_quiz_btn': 'Tomar Quiz de Comida',
        'accessibility_title': 'Opciones de Accesibilidad',
        'accessibility_tts_label': 'Texto a Voz',
        'accessibility_tts_off': 'Apagado',
        'accessibility_tts_on': 'Encendido',
        'accessibility_language_label': 'Idioma',
        'accessibility_font_label': 'Tipo de Fuente',
        'accessibility_font_regular': 'Regular',
        'accessibility_font_dyslexic': 'Comic Sans',
        'accessibility_contrast_label': 'Alto Contraste',
        'accessibility_contrast_normal': 'Normal',
        'accessibility_contrast_high': 'Alto Contraste',
        'accessibility_text_size_label': 'Tamaño del Texto',
        'Fruit Smoothie': 'Batido de Frutas', 'Refreshing fruit smoothie': 'Refrescante batido de frutas',
        'Banana': 'Plátano', 'Berries': 'Bayas', 'Yogurt': 'Yogur', 'Milk': 'Leche', 'Honey': 'Miel',
        'Add fruits': 'Añadir frutas', 'Add yogurt and milk': 'Añadir yogur y leche', 'Blend until smooth': 'Batir hasta que esté suave', 'Add honey to taste': 'Añadir miel al gusto',
        'Grilled Cheese': 'Sándwich de Queso a la Plancha', 'Classic grilled cheese sandwich': 'Clásico sándwich de queso a la plancha',
        'Bread': 'Pan', 'Cheese': 'Queso', 'Butter': 'Mantequilla',
        'Butter bread': 'Untar mantequilla en el pan', 'Add cheese': 'Añadir queso', 'Grill until golden': 'Asar hasta dorar',
    },
    'zh-CN': {
        'Edible': '可食用的',
        'Culinary Adventures for Young Chefs': '年轻厨师的烹饪冒险',
        'nav_recipes': '食谱',
        'nav_equipment': '设备',
        'nav_questions': '问题',
        'nav_documentation': '文档',
        'nav_cooks': '厨师',
        'q1_text': '你以前做过饭吗？',
        'q2_text': '你喜欢尝试新食物吗？',
        'q3_text': '你对食物有多大的冒险精神？',
        'q4_text': '你有多喜欢烹饪？',
        'q5_text': '你在厨房有多自信？',
        'yes_option': '是',
        'no_option': '不',
        'done_button': '完成',
        'slider_value_prefix': '价值: ',
        'recipes_title': '我们的食谱',
        'skill_level_prompt': '选择您的技能水平',
        'skill_level_beginner': '初学者',
        'skill_level_intermediate': '中级',
        'skill_level_advanced': '高级',
        'show_favorite_recipes': '显示最喜欢的食谱',
        'view_recipe_btn': '查看食谱',
        'skill_level_label': '技能等级',
        'ingredients_label': '配料',
        'instructions_label': '说明',
        'back_to_recipes_btn': '返回食谱',
        'equipment_title': "儿童厨房设备",
        'cooks_title': '厨师',
        'chef1_name': '张三',
        'chef1_title': '主厨',
        'chef1_bio': '张三有超过10年的烹饪经验，并且热衷于创造新的食谱。',
        'chef2_name': '李四',
        'chef2_title': '副厨师长',
        'chef2_bio': '李四是一位技艺精湛的厨师，专注于制作美味健康的餐点。',
        'questions_forum_title': '问题论坛',
        'form_name_label': '你的名字：',
        'form_email_label': '你的邮件：',
        'form_question_label': '你的问题：',
        'form_send_button': '发送邮件',
        'doc_title': 'Edible 应用文档',
        'result_skill_level_prefix': '你的烹饪技能等级：',
        'result_recommendation_intro': '根据您的调查结果，这里有一些推荐的食谱：',
        'result_show_more_btn': '显示更多食谱',
        'result_take_quiz_btn': '参加美食测验',
        'accessibility_title': '无障碍选项',
        'accessibility_tts_label': '文本转语音',
        'accessibility_tts_off': '关闭',
        'accessibility_tts_on': '开启',
        'accessibility_language_label': '语言',
        'accessibility_font_label': '字体类型',
        'accessibility_font_regular': '常规',
        'accessibility_font_dyslexic': 'Comic Sans',
        'accessibility_contrast_label': '高对比度',
        'accessibility_contrast_normal': '正常',
        'accessibility_contrast_high': '高对比度',
        'accessibility_text_size_label': '文字大小',
        'Fruit Smoothie': '水果冰沙', 'Refreshing fruit smoothie': '清爽水果冰沙',
        'Banana': '香蕉', 'Berries': '浆果', 'Yogurt': '酸奶', 'Milk': '牛奶', 'Honey': '蜂蜜',
        'Add fruits': '加入水果', 'Add yogurt and milk': '加入酸奶和牛奶', 'Blend until smooth': '搅拌至顺滑', 'Add honey to taste': '加入蜂蜜调味',
        'Grilled Cheese': '烤奶酪三明治', 'Classic grilled cheese sandwich': '经典烤奶酪三明治',
        'Bread': '面包', 'Cheese': '奶酪', 'Butter': '黄油',
        'Butter bread': '涂黄油面包', 'Add cheese': '加入奶酪', 'Grill until golden': '烤至金黄',
    },
    fr: {
        'nav_cooks': 'Chefs',
    },
    hi: {
        'nav_cooks': 'रसोइए',
    },
    ru: {
        'nav_cooks': 'Повара',
    }
};

function translateKey(key, language) {
    if (translations[language] && translations[language][key]) {
        return translations[language][key];
    }
    if (translations.en && translations.en[key]) { // Fallback to English
        return translations.en[key];
    }
    return key; // Return the key itself if no translation found
}

function translateRecipeText(text, language) {
    if (language === 'en' || !text) return text; // English is the base, or empty text
    return translations[language]?.[text] || text; // Assumes 'text' (e.g., 'Fruit Smoothie', 'Banana') is a key
}

async function translateAllContent(targetLanguage) {
    currentLanguage = targetLanguage; // Set current language

    document.querySelectorAll('[data-translate]').forEach(element => {
        const key = element.getAttribute('data-translate');
        element.textContent = translateKey(key, targetLanguage);
    });
    
    // Manually update elements not covered by data-translate or needing special handling
    // For example, if the main H1 and subtitle don't have data-translate, or if their keys are their English text:
    const mainTitle = document.querySelector('header a h1');
    if(mainTitle) mainTitle.textContent = translateKey('Edible', targetLanguage);
    
    const subtitle = document.querySelector('header .subtitle');
    if(subtitle) subtitle.textContent = translateKey('Culinary Adventures for Young Chefs', targetLanguage);

    // Update text inside accessibility menu selects
    const ttsSelect = document.getElementById('tts-option');
    if (ttsSelect) {
        ttsSelect.options[0].textContent = translateKey('accessibility_tts_off', targetLanguage);
        ttsSelect.options[1].textContent = translateKey('accessibility_tts_on', targetLanguage);
    }
    const fontSelect = document.getElementById('font-option');
    if (fontSelect) {
        fontSelect.options[0].textContent = translateKey('accessibility_font_regular', targetLanguage);
        fontSelect.options[1].textContent = translateKey('accessibility_font_dyslexic', targetLanguage);
    }
    const contrastSelect = document.getElementById('contrast-option');
    if (contrastSelect) {
         contrastSelect.options[0].textContent = translateKey('accessibility_contrast_normal', targetLanguage);
         contrastSelect.options[1].textContent = translateKey('accessibility_contrast_high', targetLanguage);
    }


    // Re-render dynamic content if visible
    if (document.getElementById('recipes') && document.getElementById('recipes').style.display !== 'none') {
        const skillSlider = document.getElementById('skill-level-slider');
        // Ensure updateSkillLevelRecipes is called only if the slider exists.
        if (skillSlider) {
             updateSkillLevelRecipes(skillSlider.value);
        } else {
            // Fallback if slider is not found, maybe show default recipes
            showRecipes();
        }
    }
    const recipeContainer = document.querySelector('#recipe-container');
    if (recipeContainer && recipeContainer.style.display === 'block' && recipeContainer.innerHTML.trim() !== '') {
        const recipeTitleElement = recipeContainer.querySelector('.recipe h3[data-recipe-id]');
        if (recipeTitleElement) {
            const displayedRecipeId = recipeTitleElement.dataset.recipeId;
            if (displayedRecipeId) showRecipe(displayedRecipeId); // This will re-render with translation
        }
    }
    
    // If documentation is visible, its title needs update
    if (document.getElementById('documentation') && document.getElementById('documentation').style.display === 'block') {
        const docTitle = document.querySelector('#documentation h2');
        if (docTitle) {
            docTitle.textContent = translateKey('doc_title', currentLanguage);
        }
    }

    // If equipment is visible, re-render
    if (document.getElementById('equipment') && document.getElementById('equipment').style.display !== 'none') {
         displayEquipment(); // This function will re-render with currentLanguage
    }

    // If results are visible, re-render them
     if (document.getElementById('result-container') && document.getElementById('result-container').style.display === 'block') {
        // This is tricky as showResult generates content. We might need to re-call it
        // or make its text updateable. For now, let's assume user will re-trigger survey or quiz
        // to see translated results, or add data-translate attributes to elements within #result.
        // A simpler approach is to update specific known elements if they exist.
        const resultTitle = document.querySelector('#result h2');
        // Assuming we store the last calculated skill level somewhere global or accessible
        if (resultTitle && window.lastCalculatedSkillLevel) {
             resultTitle.textContent = translateKey('result_skill_level_prefix', currentLanguage) + window.lastCalculatedSkillLevel;
        }
        const resultIntro = document.querySelector('#result p');
         if (resultIntro) {
            resultIntro.textContent = translateKey('result_recommendation_intro', currentLanguage);
        }
        // Buttons in result are dynamically added, need to be handled when created or by re-calling showResult
        // We might need to re-call showResult if the structure is complex and requires re-generation.
        // However, re-calling showResult might be undesirable if it causes side effects.
        // Let's try to update specific elements first.
         document.querySelectorAll('#result-container button').forEach(btn => {
             // Check if the button has a specific purpose we can translate its text for
             if (btn.onclick && btn.onclick.toString().includes('showRecommendedRecipes')) {
                 btn.textContent = translateKey('result_show_more_btn', currentLanguage);
             } else if (btn.onclick && btn.onclick.toString().includes('startFoodQuiz')) {
                 btn.textContent = translateKey('result_take_quiz_btn', currentLanguage);
             }
         });
    }

    // If food quiz is visible, re-render it
    const foodQuizContainer = document.getElementById('food-quiz');
     if (foodQuizContainer && foodQuizContainer.style.display !== 'none') {
         // Re-render the current question and choices
         if (currentQuizQuestion < foodQuizQuestions.length) {
             showFoodQuizQuestion();
         } else {
             completeFoodQuiz(); // Re-show results if quiz is finished
         }
         // Update quiz specific titles if they exist outside question/choices area
         const quizTitle = foodQuizContainer.querySelector('h2[data-translate="food_quiz_title"]');
         if(quizTitle) quizTitle.textContent = translateKey('food_quiz_title', currentLanguage);
         const quizResultsTitle = foodQuizContainer.querySelector('h2[data-translate="food_quiz_results_title"]');
         if(quizResultsTitle) quizResultsTitle.textContent = translateKey('food_quiz_results_title', currentLanguage);
         // Update score/feedback text if visible - this might be complex depending on how it's generated
     }
}

function initializeTranslationAndAccessibility() {
    const languageSelects = [
        document.getElementById('language-select'),
        document.getElementById('language-option')
    ];

    languageSelects.forEach(select => {
        if (select) {
            select.addEventListener('change', function() {
                const selectedLanguage = this.value;
                // Synchronize other select if it exists
                languageSelects.forEach(s => {
                    if (s !== this && s) s.value = selectedLanguage;
                });
                translateAllContent(selectedLanguage);
            });
        }
    });
     // Initialize with current browser language or default to English
    const initialLanguage = navigator.language.split('-')[0];
    const supportedLanguages = ['en', 'es', 'zh-CN', 'fr', 'hi', 'ru']; // zh-CN needs to be zh
    let langToSet = 'en';
    if (supportedLanguages.includes(initialLanguage)) {
        langToSet = initialLanguage;
    } else if (initialLanguage === 'zh' && supportedLanguages.includes('zh-CN')) {
        langToSet = 'zh-CN';
    }

    languageSelects.forEach(s => { if (s) s.value = langToSet; });
    translateAllContent(langToSet);
}

let currentQuestion = 1;
let answers = {};
let questions = [{
  question: "FAQ: So How do you like your cheese sir?",
  answer: "drippy"
}];
let recipes = [
    {
      id: 'smoothie',
      name: 'Fruit Smoothie',
      description: 'Refreshing fruit smoothie',
      ingredients: ['Banana', 'Berries', 'Yogurt', 'Milk', 'Honey'],
      instructions: ['Add fruits', 'Add yogurt and milk', 'Blend until smooth', 'Add honey to taste'],
      image: 'assets/smoothie.webp'
    }, {
      id: 'grilled-cheese',
      name: 'Grilled Cheese',
      description: 'Classic grilled cheese sandwich',
      ingredients: ['Bread', 'Cheese', 'Butter'],
      instructions: ['Butter bread', 'Add cheese', 'Grill until golden'],
      image: 'https://cdn.pixabay.com/photo/2021/04/05/14/48/cheese-platter-6153716_1280.jpg'
    }, {
      id: 'scrambled-eggs',
      name: 'Scrambled Eggs',
      description: 'Perfect scrambled eggs',
      ingredients: ['Eggs', 'Milk', 'Salt', 'Pepper', 'Butter'],
      instructions: ['Beat eggs with milk', 'Heat pan', 'Add eggs', 'Stir until done'],
      image: 'https://cdn.pixabay.com/photo/2021/08/29/11/00/scrambled-eggs-6582990_1280.jpg'
    },
    // Add more recipes here
];
let currentLanguage = 'en';

let foodQuizQuestions = [
  {
    question: "Which country is known for originating sushi?",
    choices: ["China", "Japan", "South Korea", "Thailand"],
    correctAnswer: 1
  },
  {
    question: "What is the primary ingredient in guacamole?",
    choices: ["Tomato", "Avocado", "Lime", "Onion"],
    correctAnswer: 1
  },
  // Add more questions here
];
let currentQuizQuestion = 0;
let foodQuizScore = 0;

function showSection(sectionId) {
  // Hide all main sections
  const sections = ['quiz', 'recipes', 'suggestions', 'questions', 'documentation', 'cooks', 'equipment', 'result-container', 'recipe-container'];
  sections.forEach(id => {
    const sectionElement = document.getElementById(id);
    if (sectionElement) {
      sectionElement.style.display = 'none';
    }
  });

  // Show the selected section
  const selectedSection = document.getElementById(sectionId);
  if (selectedSection) {
    selectedSection.style.display = 'block';
  }

  // Special handling for specific sections
  if (sectionId === 'recipes') {
    showRecipes(); 
  } else if (sectionId === 'documentation') {
    showDocumentation(); 
  } else if (sectionId === 'equipment') {
    displayEquipment();
  }
}

function showDocumentation() {
  const documentationSection = document.getElementById('documentation');
  if (documentationSection) {
    documentationSection.innerHTML = `
      <h2 data-translate="doc_title">${translateKey('doc_title', currentLanguage)}</h2>
      <iframe 
        src="https://docs.google.com/presentation/d/e/2PACX-1vRQVW5HriT-ggSWD8nPClE2x41raBzSf9JFR1fxUWqky7LrLL7tHankodr89jNXBUt-gOYzyGuJdty6/pubembed?start=true&loop=false&delayms=3000" 
        frameborder="0" 
        width="100%" 
        height="600" 
        allowfullscreen="true" 
        mozallowfullscreen="true" 
        webkitallowfullscreen="true">
      </iframe>
    `;
  }
}

function getRecipeSkillLevel(recipe) {
    const ingredientCount = recipe.ingredients.length;
    const instructionComplexity = recipe.instructions.reduce((complexity, instruction) => {
        return complexity + (instruction.split(' ').length > 5 ? 1 : 0);
    }, 0);

    // Create a more detailed skill level calculation (1-25)
    let skillScore = ingredientCount * 2 + instructionComplexity * 3;
    
    // Adjust based on specific ingredients or techniques
    const complexIngredients = ['saffron', 'truffle', 'puff pastry', 'soufflé', 'phyllo', 'yeast'];
    const complexTechniques = ['caramelize', 'deglaze', 'braise', 'poach', 'temper', 'fold', 'reduce'];
    
    complexIngredients.forEach(ingredient => {
        if (recipe.ingredients.some(ing => ing.toLowerCase().includes(ingredient))) {
            skillScore += 3;
        }
    });
    
    complexTechniques.forEach(technique => {
        if (recipe.instructions.some(inst => inst.toLowerCase().includes(technique))) {
            skillScore += 2;
        }
    });

    // Normalize to 1-25 range
    return Math.min(Math.max(Math.round(skillScore), 1), 25);
}

function updateSkillLevelRecipes(skillLevel) {
    // Define a range of +/- 3 skill levels around the selected level
    const minSkillLevel = Math.max(1, parseInt(skillLevel) - 3);
    const maxSkillLevel = Math.min(25, parseInt(skillLevel) + 3);
    
    const filteredRecipes = recipes.filter(recipe => {
        const recipeSkillLevel = getRecipeSkillLevel(recipe);
        return recipeSkillLevel >= minSkillLevel && recipeSkillLevel <= maxSkillLevel;
    });

    // Randomly select 3 recipes from the filtered list
    const selectedRecipes = filteredRecipes
        .sort(() => 0.5 - Math.random())
        .slice(0, 3);

    displayRecipes(selectedRecipes);
}

function showRecipes() {
    const skillSlider = document.getElementById('skill-level-slider');
    if (skillSlider) {
        updateSkillLevelRecipes(skillSlider.value || 13); // Use current slider value or default
    } else {
         // This case might occur if the recipes section is shown before slider is fully available
         // or if the element ID is incorrect. For now, default to 13.
        updateSkillLevelRecipes(13);
    }
}

function displayRecipes(recipeList) {
    let recipesDiv = document.getElementById('recipe-list');
    recipesDiv.innerHTML = recipeList.map(recipe => {
        const recipeSkillLevel = getRecipeSkillLevel(recipe);
        return `
        <div class="dish-box">
            <img src="${recipe.image}" alt="${translateRecipeText(recipe.name, currentLanguage)}" width="100%" height="200">
            <h3>${translateRecipeText(recipe.name, currentLanguage)}</h3>
            <p>${translateRecipeText(recipe.description, currentLanguage)}</p>
            <p><strong>${translateKey('skill_level_label', currentLanguage)}:</strong> ${recipeSkillLevel}/25</p>
            <button class="nav-btn" onclick="showRecipe('${recipe.id}')">${translateKey('view_recipe_btn', currentLanguage)}</button>
        </div>
    `}).join('');

    gsap.fromTo('.dish-box', {
        opacity: 0,
        y: 20
    }, {
        opacity: 1,
        y: 0,
        duration: 0.5,
        stagger: 0.2
    });
}

function showRecipe(recipeId) {
    let recipe = recipes.find(r => r.id === recipeId);
    if (!recipe) return; // Recipe not found

    let recipeContent = `
        <h3 data-recipe-id="${recipe.id}">${translateRecipeText(recipe.name, currentLanguage)}</h3>
        <img src="${recipe.image}" alt="${translateRecipeText(recipe.name, currentLanguage)}" width="100%" height="300" style="object-fit: cover; border-radius: 10px;">
        <p><strong>${translateKey('skill_level_label', currentLanguage)}:</strong> ${getRecipeSkillLevel(recipe)}/25</p>
        <h4>${translateKey('ingredients_label', currentLanguage)}:</h4>
        <ul>
            ${recipe.ingredients.map(ingredient => `<li>${translateRecipeText(ingredient, currentLanguage)}</li>`).join('')}
        </ul>
        <h4>${translateKey('instructions_label', currentLanguage)}:</h4>
        <ol>
            ${recipe.instructions.map(instruction => `<li>${translateRecipeText(instruction, currentLanguage)}</li>`).join('')}
        </ol>
        <button class="nav-btn back-btn" onclick="hideRecipe()">${translateKey('back_to_recipes_btn', currentLanguage)}</button>
    `;
    let recipeContainer = document.querySelector('#recipe-container');
    recipeContainer.innerHTML = `
        <div class="recipe">
            ${recipeContent}
        </div>
    `;
    recipeContainer.style.display = 'block';
    gsap.fromTo(recipeContainer, {
        opacity: 0,
        y: 20
    }, {
        opacity: 1,
        y: 0,
        duration: 0.5
    });
    recipeContainer.scrollIntoView({
        behavior: 'smooth'
    });
}

function hideRecipe() {
    gsap.to('#recipe-container', {
        opacity: 0,
        y: 20,
        duration: 0.5,
        onComplete: () => {
            document.querySelector('#recipe-container').style.display = 'none';
        }
    });
}

function showResult() {
    let adventurousness = parseInt(answers[3] || 5);
    let cookingLikelihood = parseInt(answers[4] || 5);
    let confidence = parseInt(answers[5] || 5);

    let totalScore = adventurousness + cookingLikelihood + confidence;
    
    let skillLevels = {
        0: 'Beginner',
        15: 'Novice',
        25: 'Intermediate', 
        35: 'Advanced',
        45: 'Master',
        55: 'GOD'
    };

    let userSkillLevel = Object.keys(skillLevels)
        .reverse()
        .find(threshold => totalScore >= parseInt(threshold)) || 'Beginner';

    let recommendedRecipes = recipes.filter(recipe => 
        getRecipeSkillLevel(recipe) === skillLevels[Object.keys(skillLevels).find(threshold => 
            userSkillLevel === skillLevels[threshold]
        )]
    );

    recommendedRecipes = recommendedRecipes.slice(0, 3);

    let resultContainer = document.getElementById('result-container');
    let resultDiv = document.getElementById('result');
    let recommendedDishesDiv = document.getElementById('recommended-dishes');

    resultDiv.innerHTML = `
        <h2>${translateKey('result_skill_level_prefix', currentLanguage)}${userSkillLevel}</h2>
        <p>${translateKey('result_recommendation_intro', currentLanguage)}</p>
    `;

    recommendedDishesDiv.innerHTML = recommendedRecipes.map(recipe => `
        <div class="dish-box">
            <img src="${recipe.image}" alt="${translateRecipeText(recipe.name, currentLanguage)}" width="100%" height="200">
            <h3>${translateRecipeText(recipe.name, currentLanguage)}</h3>
            <p>${translateRecipeText(recipe.description, currentLanguage)}</p>
            <button class="nav-btn" onclick="showRecipe('${recipe.id}')">${translateKey('view_recipe_btn', currentLanguage)}</button>
        </div>
    `).join('');

    document.querySelectorAll('main > div').forEach(div => div.style.display = 'none');
    resultContainer.style.display = 'block';

    gsap.fromTo('.dish-box', {
        opacity: 0,
        y: 20
    }, {
        opacity: 1,
        y: 0,
        duration: 0.5,
        stagger: 0.2
    });

    resultDiv.innerHTML += `
        <button class="nav-btn" onclick="showRecommendedRecipes('${userSkillLevel}')">${translateKey('result_show_more_btn', currentLanguage)}</button>
        <button class="nav-btn" onclick="startFoodQuiz()">${translateKey('result_take_quiz_btn', currentLanguage)}</button>
    `;
}

function showRecommendedRecipes(skillLevel) {
    const recipesContainer = document.getElementById('recipes');
    const recipeList = document.getElementById('recipe-list');
    const skillLevelSlider = document.getElementById('skill-level-slider');
    
    // Find the index of the skill level
    const skillLevels = ['Beginner', 'Intermediate', 'Master'];
    const skillIndex = skillLevels.indexOf(skillLevel) + 1;
    
    // Set the skill level slider
    skillLevelSlider.value = skillIndex;
    
    // Update and show recipes
    updateSkillLevelRecipes(skillIndex);
    
    // Switch to recipes section
    showSection('recipes');
}

function startFoodQuiz() {
    const resultContainer = document.getElementById('result-container'); // Quiz shown in place of results
    if (!resultContainer) return;
    // Hide other main sections if quiz is started from a different context
    showSection('result-container'); //This effectively hides other main sections and shows result-container

    resultContainer.innerHTML = `
        <div id="food-quiz">
            <h2 data-translate="food_quiz_title">${translateKey('food_quiz_title', currentLanguage)}</h2>
            <div id="quiz-question"></div>
            <div id="quiz-choices"></div>
            <div id="quiz-feedback"></div>
        </div>
    `;
    currentQuizQuestion = 0;
    foodQuizScore = 0;
    showFoodQuizQuestion();
}

function showFoodQuizQuestion() {
    const quizQuestion = foodQuizQuestions[currentQuizQuestion];
    const questionDiv = document.getElementById('quiz-question');
    const choicesDiv = document.getElementById('quiz-choices');
    
    questionDiv.innerHTML = `<h3>${quizQuestion.question}</h3>`;
    
    choicesDiv.innerHTML = quizQuestion.choices.map((choice, index) => `
        <button class="quiz-choice-btn" onclick="checkFoodQuizAnswer(${index})">
            ${translateRecipeText(choice, currentLanguage)}
        </button>
    `).join('');
}

function checkFoodQuizAnswer(selectedIndex) {
    const quizQuestion = foodQuizQuestions[currentQuizQuestion];
    const feedbackDiv = document.getElementById('quiz-feedback');
    const choices = quizQuestion.choices.map(choice => translateRecipeText(choice, currentLanguage)); // Translate choices if they are keys
    
    if (selectedIndex === quizQuestion.correctAnswer) {
        foodQuizScore++;
        feedbackDiv.innerHTML = `<p style="color: green;">${translateKey('quiz_correct_feedback', currentLanguage)}</p>`;
    } else {
        feedbackDiv.innerHTML = `<p style="color: red;">${translateKey('quiz_incorrect_feedback', currentLanguage)} ${choices[quizQuestion.correctAnswer]}</p>`;
    }
    
    currentQuizQuestion++;
    
    if (currentQuizQuestion < foodQuizQuestions.length) {
        setTimeout(() => {
            feedbackDiv.innerHTML = '';
            showFoodQuizQuestion();
        }, 2000);
    } else {
        setTimeout(completeFoodQuiz, 2000);
    }
}

function completeFoodQuiz() {
    const quizContainer = document.getElementById('food-quiz');
    if (!quizContainer) return;
    const maxScore = foodQuizQuestions.length;
    const scorePercentage = (foodQuizScore / maxScore) * 100;
    
    let userSkillLevel = 'Beginner';
    
    if (scorePercentage === 100) {
        userSkillLevel = 'GOD';
    } else if (scorePercentage >= 80) {
        userSkillLevel = 'Master';
    } else if (scorePercentage >= 60) {
        userSkillLevel = 'Advanced';
    } else if (scorePercentage >= 40) {
        userSkillLevel = 'Intermediate';
    } else if (scorePercentage >= 20) {
        userSkillLevel = 'Novice';
    }
    
    quizContainer.innerHTML = `
        <h2 data-translate="food_quiz_results_title">${translateKey('food_quiz_results_title', currentLanguage)}</h2>
        <p>${translateKey('food_quiz_score_prefix', currentLanguage)} ${foodQuizScore} ${translateKey('food_quiz_score_out_of', currentLanguage)} ${maxScore}</p>
        <p>${translateKey('food_quiz_knowledge_level_prefix', currentLanguage)} ${userSkillLevel}</p>
        <button class="nav-btn" onclick="showRecommendedRecipes('${userSkillLevel}')">${translateKey('result_show_more_btn', currentLanguage)}</button>
    `;
}

let kitchenEquipment = [
    {
        id: 'oxo-utensil-set',
        name: 'OXO Good Grips 15-Piece Kitchen Tool Set',
        description: 'A comprehensive kitchen tool set perfect for young chefs, featuring safe and comfortable handles',
        price: '$123.97',
        amazonLink: 'https://www.amazon.com/OXO-Steel-Piece-Utensil-Stainless/dp/B09ZLXKS4D',
        image: 'https://m.media-amazon.com/images/I/71rg7qg1YSL._AC_SL1500_.jpg',
        features: [
            'Stainless steel construction',
            'Comfortable, soft-grip handles',
            'Dishwasher safe',
            'Includes multiple essential kitchen tools'
        ]
    },
    // Add more equipment here
];

function displayEquipment() {
    const equipmentList = document.getElementById('equipment-list');
    if (!equipmentList) return; // Ensure element exists before trying to update it
    equipmentList.innerHTML = kitchenEquipment.map(item => `
        <div class="equipment-box">
            <img src="${item.image}" alt="${translateRecipeText(item.name, currentLanguage)}" width="100%" height="250">
            <h3>${translateRecipeText(item.name, currentLanguage)}</h3>
            <p>${translateRecipeText(item.description, currentLanguage)}</p>
            <p><strong>${translateKey('equipment_price_label', currentLanguage)}:</strong> ${item.price}</p>
            <ul>
                ${item.features.map(feature => `<li>${translateRecipeText(feature, currentLanguage)}</li>`).join('')}
            </ul>
            <a href="${item.amazonLink}" target="_blank" class="nav-btn">${translateKey('equipment_view_on_amazon_btn', currentLanguage)}</a>
        </div>
    `).join('');

    gsap.fromTo('.equipment-box', {
        opacity: 0,
        y: 20
    }, {
        opacity: 1,
        y: 0,
        duration: 0.5,
        stagger: 0.2
    });
}

function resetSurvey() {
    // Hide all main sections (EXCEPT quiz potentially, but ensure others are hidden)
    // and make sure the quiz section itself IS visible.
    const allMainSectionsExceptQuiz = ['recipes', 'suggestions', 'questions', 'documentation', 'cooks', 'equipment', 'result-container', 'recipe-container', 'food-quiz']; // Add 'food-quiz' here
    allMainSectionsExceptQuiz.forEach(id => {
        const sectionElement = document.getElementById(id);
        if (sectionElement) {
            sectionElement.style.display = 'none';
        }
    });
    const quizSection = document.getElementById('quiz');
    if (quizSection) {
        quizSection.style.display = 'block'; // Ensure quiz section is visible
    }

    // Reset all questions to their initial state
    const questionsElements = document.querySelectorAll('#quiz .question'); // Target questions within #quiz
    questionsElements.forEach((question, index) => {
        question.style.display = index === 0 ? 'block' : 'none';
        // GSAP animation for the first question
        if (index === 0) {
             gsap.fromTo(question, { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.5 });
        }
    });
    
    answers = {};
    currentQuestion = 1;

    // Hide result container explicitly, as it's not in allMainSectionsExceptQuiz
    const resultContainer = document.getElementById('result-container');
    if (resultContainer) {
        resultContainer.style.display = 'none';
    }
    const recipeContainer = document.getElementById('recipe-container');
    if (recipeContainer) {
        recipeContainer.style.display = 'none';
    }

    // Optional: Reset any sliders to their default values
    const sliders = document.querySelectorAll('#quiz .slider');
    sliders.forEach(slider => {
        slider.value = 5; // Default value
        // Assuming slider IDs are like 'q3-slider', then questionNumber is 3
        const qNum = slider.id.split('-')[0].substring(1); // Extracts '3' from 'q3-slider'
        if (qNum) {
            const valueSpan = document.getElementById(`q${qNum}-value`);
            if (valueSpan) {
                valueSpan.textContent = '5';
            }
        }
    });
}

function nextQuestion(currentQuestionNumber, answer) {
    // Store the answer for this question
    answers[currentQuestionNumber] = answer;

    // Hide current question
    const currentQuestionElement = document.getElementById(`q${currentQuestionNumber}`);
    if (currentQuestionElement) {
        currentQuestionElement.style.display = 'none';
    }

    // Move to next question
    currentQuestion++;

    // Check if we've reached the end of the survey
    if (currentQuestion > 5) {
        // Display result
        showResult();
        return;
    }

    // Show next question with animation
    const nextQuestionElement = document.getElementById(`q${currentQuestion}`);
    if (nextQuestionElement) {
        gsap.fromTo(nextQuestionElement, {
            opacity: 0,
            y: 20
        }, {
            opacity: 1,
            y: 0,
            duration: 0.5
        });
        nextQuestionElement.style.display = 'block';
    }
}

function updateSliderValue(questionNumber, value) {
    const valueSpan = document.getElementById(`q${questionNumber}-value`);
    if (valueSpan) {
        valueSpan.textContent = value;
    }
}

// Accessibility Functions
function toggleAccessibilityMenu() {
    const menu = document.getElementById('accessibility-menu');
    if (menu) {
        menu.classList.toggle('show');
    }
}

function toggleTTS(value) {
    // Implement text-to-speech logic here
    // For example, enabling/disabling speaking on hover/click
    console.log("TTS toggled:", value); // Placeholder
}

function toggleDyslexicFont(value) {
    const body = document.body;
    if (value === 'dyslexic') {
        body.classList.add('dyslexic-font');
    } else {
        body.classList.remove('dyslexic-font');
    }
}

function toggleHighContrast(value) {
    const body = document.body;
    if (value === 'high') {
        body.classList.add('high-contrast');
    } else {
        body.classList.remove('high-contrast');
    }
}

function adjustTextSize(value) {
    document.body.style.fontSize = value + '%';
}

document.addEventListener('DOMContentLoaded', () => {
    initializeTranslationAndAccessibility(); // Initialize languages first
    resetSurvey(); // Call resetSurvey directly to setup and display the quiz initially.
});

particlesJS("particles-js", {
    particles: {
        number: {
            value: 80,
            density: {
                enable: true,
                value_area: 800
            }
        },
        color: {
            value: "#ffffff"
        },
        shape: {
            type: "circle",
            stroke: {
                width: 0,
                color: "#000000"
            },
            polygon: {
                nb_sides: 5
            },
            image: {
                src: "img/github.svg",
                width: 100,
                height: 100
            }
        },
        opacity: {
            value: 0.5,
            random: false,
            anim: {
                enable: false,
                speed: 1,
                opacity_min: 0.1,
                sync: false
            }
        },
        size: {
            value: 3,
            random: true,
            anim: {
                enable: false,
                speed: 40,
                size_min: 0.1,
                sync: false
            }
        },
        line_linked: {
            enable: true,
            distance: 150,
            color: "#ffffff",
            opacity: 0.4,
            width: 1
        },
        move: {
            enable: true,
            speed: 6,
            direction: "none",
            random: false,
            straight: false,
            out_mode: "out",
            bounce: false,
            attract: {
                enable: false,
                rotateX: 600,
                rotateY: 1200
            }
        }
    },
    interactivity: {
        detect_on: "canvas",
        events: {
            onhover: {
                enable: true,
                mode: "repulse"
            },
            onclick: {
                enable: true,
                mode: "push"
            },
            resize: true
        },
        modes: {
            grab: {
                distance: 400,
                line_linked: {
                    opacity: 1
                }
            },
            bubble: {
                distance: 400,
                size: 40,
                duration: 2,
                opacity: 8,
                speed: 3
            },
            repulse: {
                distance: 200,
                duration: 0.4
            },
            push: {
                particles_nb: 4
            },
            remove: {
                particles_nb: 2
            }
        }
    },
    retina_detect: true
});
